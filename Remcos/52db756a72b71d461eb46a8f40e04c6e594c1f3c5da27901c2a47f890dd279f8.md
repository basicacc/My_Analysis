At the time of writing it is around a day that malicious script appeared in wild. To practice and improve myself I chose this malware.

For now in virustotal, it can be seen that malware is only detected by 9 AVs and the server for downloading second payload (*png* file) is still available to be downloaded. 

Starting with analysis, The file's size is really big but only reason for it was repeat of same 10 lines. 
![1|500](https://github.com/basicacc/basicacc.github.io/blob/main/My_analysis/Malware_4/1.png?raw=true)

Using ASCII table we can replace all occurrences of these variables with their Char values.

At first it looked like it is only repeating same 10 line for increasing file size (to look legit), but one more reason was probably trying to hide obfuscated code. (Maybe not but only good explanation is this)
![1|1000](https://github.com/basicacc/basicacc.github.io/blob/main/My_analysis/Malware_4/2.png?raw=true)

At first it might not make sense but you can obviously see same pattern repeat in obfuscated code:
`"‚è≥‡§≤·Éë‚£ø‡ºë‚Ç´·®ë‘øüñ≤·Ö´“å‚ä£·àí»™‚üö"`

and payload use `categorised(ByVal inputText)` function to deobfuscate it. (By removing repeating line)
![1|800](https://github.com/basicacc/basicacc.github.io/blob/main/My_analysis/Malware_4/3.png?raw=true)

In this situation manually writing deobfuscater  would be possible to but, it is waste of time. I just changed `dozens = categorised(dozens)` with `WScript.Echo categorised(dozens)` (Don't forget to only copy necessary parts in new file to avoid running something dangerous). I ran the code using **cscript.exe** to see output in my **cmd**.

![1|800](https://github.com/basicacc/basicacc.github.io/blob/main/My_analysis/Malware_4/4.png?raw=true)

Now to deobfuscate, we need to replace '#' with 'A' and convert base64 to string. Once again instead of using cyberchef I just run powershell code with removing `Invoke-Expression` and beautify it a little bit. This is the code that downloads second file. (png)

![1|800](https://github.com/basicacc/basicacc.github.io/blob/main/My_analysis/Malware_4/5.png?raw=true)
A day later, the malicious file was deleted from server but I installed it before, so I can continue my analysis. I will also upload file to **malware bazaar** for anyone that needs it to analyse on his own.

This image file has Data starting with '<<BASE64_START>>' and ends with '<<BASE64_END>>' after decoded it is uploaded to memory but I modified code and used function:
```ps1
[System.IO.File]::WriteAllBytes("C:\dnlib_image.dll", $cleared)
```

to save it in a file and continue my static analysis.

In next line we can see the malicious code calling specific function that is interesting for us, **VAI**.

![1|1000](https://github.com/basicacc/basicacc.github.io/blob/main/My_analysis/Malware_4/6.png?raw=true)

some of the variable names are written in Spanish, which might be a tip for malware writer being Spanish. (Of course, it is not a guarantee) 

(Will continue had to analyse dll which took most of my time)